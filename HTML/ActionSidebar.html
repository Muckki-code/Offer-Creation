<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f7fa;
        color: #263238;
        padding: 0;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
      }
      .container {
        background-color: #ffffff;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow-y: auto;
      }
      h1 {
        font-size: 1.25rem;
        font-weight: 800;
        color: #004d40;
        text-align: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #004d40;
      }

      .tab-nav {
        display: flex;
        border-bottom: 1px solid #ccc;
        margin-bottom: 1rem;
      }
      .tab-button {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: #455a64;
        font-size: 0.9rem;
      }
      .tab-button:hover {
        background-color: #e0f2f7;
      }
      .tab-button.active {
        color: #004d40;
        border-bottom-color: #00796b;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .action-button {
        display: block;
        width: 100%;
        text-align: left;
        background-color: #e0f2f7;
        color: #004d40;
        padding: 0.6rem 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid #b2dfdb;
        cursor: pointer;
      }
      .action-button:hover {
        background-color: #c2e9f3;
      }

      .collapsible-header {
        background-color: #e8eaf6;
        color: #303f9f;
        padding: 0.6rem 0.75rem;
        border-radius: 0.375rem;
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid #c5cae9;
      }
      .collapsible-header:hover {
        background-color: #d1d5f3;
      }
      .collapsible-arrow {
        transition: transform 0.2s ease;
      }
      .collapsible-header.active .collapsible-arrow {
        transform: rotate(90deg);
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        padding-left: 1rem;
      }
      .collapsible-content .action-button {
        background-color: #f1f8e9;
        border-color: #dcedc8;
        color: #33691e;
      }
      .collapsible-content .action-button:hover {
        background-color: #e6f3d8;
      }

      #correction-panel {
        flex-shrink: 0;
        background-color: #ffffff;
        border-top: 2px solid #ff8a65;
        padding: 1rem;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
      }

      #status-box {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ffe0b2;
        color: #e65100;
        padding: 10px;
        text-align: center;
        font-weight: 500;
        display: none;
        z-index: 100;
        transition: opacity 0.3s ease;
        opacity: 0;
      }
      #status-box.show {
        display: block;
        opacity: 1;
      }
      #status-box.success {
        background-color: #c8e6c9;
        color: #1b5e20;
      }
      #status-box.error {
        background-color: #ffcdd2;
        color: #c62828;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- This main panel will now ALWAYS be visible -->
      <div id="main-panel">
        <h1>Action Sidebar</h1>
        <div class="tab-nav">
          <button
            class="tab-button active"
            onclick="openTab(event, 'main-functions')"
          >
            Main
          </button>
          <button
            class="tab-button"
            onclick="openTab(event, 'admin-functions')"
          >
            Admin
          </button>
          <button class="tab-button" onclick="openTab(event, 'project-info')">
            Project Info
          </button>
        </div>

        <!-- All tab content remains the same -->
        <div id="main-functions" class="tab-content active">
          <!-- AE Actions -->
          <div class="collapsible-header" onclick="toggleCollapsible(event)">
            <span>AE Actions</span>
            <span class="collapsible-arrow">></span>
          </div>
          <div class="collapsible-content">
            <button
              class="action-button"
              onclick="callServerFunction('getDataFromSKU', 'Fetching data...')"
            >
              Get Data from BigQuery
            </button>
            <button
              class="action-button"
              onclick="callServerFunction('showOfferDialog', 'Opening dialog...')"
            >
              Create Offer Document
            </button>
            <button
              class="action-button"
              onclick="callServerFunction('submitItemsForApproval', 'Submitting for approval...')"
            >
              Submit Items for Approval
            </button>
          </div>
          <!-- Approver Actions -->
          <div class="collapsible-header" onclick="toggleCollapsible(event)">
            <span>Approver Actions</span>
            <span class="collapsible-arrow">></span>
          </div>
          <div class="collapsible-content">
            <button
              class="action-button"
              onclick="callServerFunction('processAllApproverActions', 'Processing actions...')"
            >
              Process All Approvals
            </button>
          </div>
        </div>
        <div id="admin-functions" class="tab-content">
          <button
            class="action-button"
            onclick="callServerFunction('runFullSheetRepair', 'Repairing sheet...')"
          >
            Repair Sheet (UX & Data)
          </button>
        </div>
        <div id="project-info" class="tab-content">
          <button
            class="action-button"
            onclick="callServerFunction('showApplicationOverviewDialog', 'Opening overview...')"
          >
            Application Overview
          </button>
        </div>
      </div>
    </div>
    <!-- Correction Panel is now at the bottom -->
    <div id="correction-panel" class="hidden"></div>

    <div id="status-box"></div>

    <script>
      let currentErrorBundleId = null; // Variable to track the currently displayed error
      let currentDisplayedErrorSignature = null; // NEW: Tracks the state of displayed errors
      
      // --- Tab Management ---
      function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
      }

      function toggleCollapsible(event) {
        const header = event.currentTarget;
        const content = header.nextElementSibling;
        header.classList.toggle("active");
        if (content.style.maxHeight && content.style.maxHeight !== "0px") {
          content.style.maxHeight = "0px";
        } else {
          content.style.maxHeight = content.scrollHeight + "px";
          content.addEventListener(
            "transitionend",
            () => {
              if (content.style.maxHeight !== "0px")
                content.style.maxHeight = "none";
            },
            { once: true }
          );
        }
      }

      // --- Status Message Handling ---
      function showStatus(message, isError = false, duration = 4000) {
        const statusBox = document.getElementById("status-box");
        if (!statusBox) return;

        statusBox.textContent = message;
        statusBox.classList.remove("success", "error");
        statusBox.classList.add(isError ? "error" : "success", "show");

        setTimeout(() => {
          statusBox.classList.remove("show");
        }, duration);
      }

      // --- Server-side Function Caller ---
      function callServerFunction(functionName, statusMessage) {
        closeCorrectionPanel(); // Hide correction panel when a main action is taken
        showStatus(statusMessage || `Executing ${functionName}...`);
        google.script.run
          .withSuccessHandler((response) => {
            showStatus(
              `${functionName.replace(/([A-Z])/g, " $1").trim()} completed.`,
              false
            );
          })
          .withFailureHandler((error) => {
            showStatus(`Error: ${error.message}`, true, 8000);
          })
          [functionName]();
      }

      // --- NEW: Correction Panel Functions ---
      // --- NEW: Polling Mechanism for UI Updates ---
      isPollingActive = setInterval(pollForUiUpdates(), 4000);

      function displayBundleErrors(errors) {
        const panel = document.getElementById("correction-panel");
        const newSignature = createErrorSignature(errors);

        // --- CORE LOGIC: Only update the DOM if the state of errors has changed ---
        if (newSignature === currentDisplayedErrorSignature) {
          console.log("No change in error state. UI update skipped.");
          return; // Do nothing if errors are the same
        }
        
        console.log(`Error state changed. Old: '${currentDisplayedErrorSignature}', New: '${newSignature}'. Updating UI.`);
        currentDisplayedErrorSignature = newSignature; // Update the signature
        
        // Show a loading/updating message immediately for better UX
        panel.innerHTML = '<p class="p-4 text-center text-gray-500">Updating errors...</p>';
        panel.classList.remove("hidden");


        if (!errors || errors.length === 0) {
          panel.innerHTML = ""; // Clear content
          panel.classList.add("hidden");
          return;
        }

        // The rest of the logic for building the UI remains the same
        if (errors.length === 1) {
          // --- Single Error: Use the existing logic ---
          const error = errors[0];
          const functionName =
            error.errorCode === "GAP_DETECTED"
              ? "getGapCorrectionHtml"
              : "getMismatchCorrectionHtml";
          const dataPayload = {
            bundleNumber: error.bundleNumber,
            // For mismatch errors, create the data payload
            ...(error.errorCode === "MISMATCH" && {
              rowNum: "N/A", // Not relevant for a proactive check
              currentValues: { term: "?", quantity: "?" }, // Placeholder
              expectedValues: error.expected,
            }),
          };
          showCorrectionPanel(functionName, dataPayload); // This function will overwrite the loading message
        } else {
          // --- Multiple Errors: Build a tabbed interface ---
          let tabHeaders = '<div class="tab-nav">';
          let tabContentsContainer = '<div class="mt-2">';

          errors.forEach((error, index) => {
            const isActive = index === 0 ? "active" : "";
            tabHeaders += `
              <button class="tab-button ${isActive}" 
                      onclick="openErrorTab(event, 'error-tab-${index}')"
                      data-error-code="${error.errorCode}"
                      data-bundle-number="${error.bundleNumber}"
                      data-expected='${JSON.stringify(error.expected || {})}'>
                Bundle #${error.bundleNumber}
              </button>
            `;
            tabContentsContainer += `<div id="error-tab-${index}" class="tab-content ${isActive}"></div>`;
          });

          tabHeaders += "</div>";
          tabContentsContainer += "</div>";
          panel.innerHTML = tabHeaders + tabContentsContainer; // This overwrites the loading message

          // Automatically load the content for the first tab
          const firstTab = panel.querySelector(".tab-button");
          if (firstTab) {
            openErrorTab({ currentTarget: firstTab }, "error-tab-0");
          }
        }
      }
      function openErrorTab(event, tabId) {
        // First, hide all tab contents and remove active class from all tab buttons
        const tabContents = document.querySelectorAll(
          "#correction-panel .tab-content"
        );
        tabContents.forEach((tc) => (tc.style.display = "none"));
        const tabButtons = document.querySelectorAll(
          "#correction-panel .tab-button"
        );
        tabButtons.forEach((tb) => tb.classList.remove("active"));

        // Show the target tab content and set the button to active
        const targetContent = document.getElementById(tabId);
        const clickedButton = event.currentTarget;
        targetContent.style.display = "block";
        clickedButton.classList.add("active");

        // Only load the content if it's not already loaded
        if (targetContent.innerHTML.trim() === "") {
          targetContent.innerHTML = '<p class="p-4 text-center">Loading...</p>';

          const errorData = clickedButton.dataset;
          const functionName =
            errorData.errorCode === "GAP_DETECTED"
              ? "getGapCorrectionHtml"
              : "getMismatchCorrectionHtml";
          const dataPayload = {
            bundleNumber: errorData.bundleNumber,
            ...(errorData.errorCode === "MISMATCH" && {
              rowNum: "N/A",
              currentValues: { term: "?", quantity: "?" },
              expectedValues: JSON.parse(errorData.expected),
            }),
          };

          google.script.run
            .withSuccessHandler(function(html) {
              targetContent.innerHTML = html;
            })
            .withFailureHandler(function(err) {
              targetContent.innerHTML = `<p class="p-4 text-red-700">Error loading content: ${err.message}</p>`;
            })
            [functionName](dataPayload);
        }
      }

      function createErrorSignature(errors) {
        if (!Array.isArray(errors) || errors.length === 0) {
          return "NO_ERRORS";
        }
        // Create a consistent signature by sorting by bundle number
        return errors
          .map(e => `${e.bundleNumber}:${e.errorCode}`)
          .sort()
          .join(';');
      }

      function pollForUiUpdates() {
        // This is a self-contained closure to manage the counter.
        let pollCounter = 0;

        return function() {
          pollCounter++;

          // First, always perform the lightweight check for live edits.
          google.script.run
            .withSuccessHandler(function(liveUpdates) {
              if (Array.isArray(liveUpdates) && liveUpdates.length > 0) {
                console.log("Found live edit errors:", liveUpdates);
                pollCounter = 0; // Reset counter after displaying live feedback
                const errorObjects = liveUpdates.map((u) => ({
                  bundleNumber: u.data.bundleNumber,
                  errorCode:
                    u.data.errorCode ||
                    (u.functionName === "getGapCorrectionHtml"
                      ? "GAP_DETECTED"
                      : "MISMATCH"),
                  errorMessage: u.data.errorMessage || "",
                  expected: u.data.expectedValues || u.data.expected || null,
                }));
                displayBundleErrors(errorObjects); // Let the new smart function decide to update
              } else {
                // If there were NO live errors, then consider a full check.
                if (pollCounter % 3 === 0) {
                  console.log("No live errors. Performing periodic full sheet audit.");
                  google.script.run
                    .withSuccessHandler(displayBundleErrors) // Let the new smart function decide
                    .getInitialBundleErrors();
                }
              }
            })
            .withFailureHandler(function(err) {
              if (isPollingActive) {
                clearInterval(isPollingActive);
                isPollingActive = false;
              }
              console.error("Polling failed:", err);
            })
            .getSidebarUpdate();
        };
      }      
      function handleSubmit(button, type) {
        button.disabled = true;

        // The logic for gathering data remains the same
        if (type === "mismatch") {
          const panel = document.getElementById("mismatch-panel-content");
          const term = document.getElementById("correctedTerm").value;
          const quantity = document.getElementById("correctedQuantity").value;
          const bundleNumber = panel.dataset.bundleNumber;
          button.textContent = "Applying...";
          google.script.run
            .withSuccessHandler(checkForInitialErrors) // <-- THIS IS THE FIX
            .handleBundleMismatchConfirmation(bundleNumber, term, quantity);
        } else if (type === "gap") {
          const panel = document.getElementById("gap-panel-content");
          const bundleNumber = panel.dataset.bundleNumber;
          button.textContent = "Fixing...";
          google.script.run
            .withSuccessHandler(checkForInitialErrors) // <-- THIS IS THE FIX
            .handleBundleGapConfirmation(bundleNumber);
        }
      }

      function handleCancel(button) {
        button.disabled = true;
        button.textContent = "Reverting...";

        // --- THIS IS THE FIX ---
        // Find the closest parent element that has the bundle number,
        // making this function generic for any error panel.
        const panel = button.closest("[data-bundle-number]");
        if (panel) {
          const bundleNumber = panel.dataset.bundleNumber;
          google.script.run
            .withSuccessHandler(checkForInitialErrors)
            .handleBundleDissolve(bundleNumber);
        } else {
          console.error("Could not find bundle number for cancel operation.");
          button.textContent = "Error";
        }
      }

      function showCorrectionPanel(functionName, data) {
        const panel = document.getElementById("correction-panel");

        currentErrorBundleId = data.bundleNumber; // Store the bundle ID
        console.log("Displaying error panel for bundle:", currentErrorBundleId);

        google.script.run
          .withSuccessHandler((htmlContent) => {
            panel.innerHTML = htmlContent;
            panel.classList.remove("hidden"); // Simply unhide the panel
            if (typeof window.initializeCorrectionDialog === "function") {
              window.initializeCorrectionDialog(data);
            }
          })
          .withFailureHandler((err) =>
            showStatus("Error loading UI: " + err.message, true)
          )
          [functionName](data);
      }

      function closeCorrectionPanel() {
        const panel = document.getElementById("correction-panel");

        currentErrorBundleId = null; // Clear the current error
        currentDisplayedErrorSignature = null; // NEW: Reset the signature
        console.log("Closing error panel and resetting signature.");

        panel.innerHTML = "";
        panel.classList.add("hidden"); // Simply hide the panel
      }
      // --- NEW: Proactive Error Checking ---
      function checkForInitialErrors() {
        console.log("Checking for initial bundle errors on load...");
        google.script.run
          .withSuccessHandler(function(errors) {
            if (errors && errors.length > 0) {
              console.log("Found initial errors:", errors);
              displayBundleErrors(errors);
            } else {
              console.log("No initial bundle errors found.");
            }
          })
          .withFailureHandler(function(err) {
            console.error("Failed to get initial bundle errors:", err);
            showStatus("Could not check for sheet errors.", true);
          })
          .getInitialBundleErrors();
      }

      // --- Initialize View & Start Polling ---
      // --- Initialize View & Start Polling ---
      // --- Initialize View & Start Polling ---
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("main-functions").classList.add("active");

        checkForInitialErrors(); // <-- ADD THIS LINE

        // Start polling for UI updates only if it hasn't been started already
        if (!isPollingActive) {
          isPollingActive = setInterval(pollForUiUpdates, 4000); // Check every 4 seconds
          console.log("UI Polling Started.");
        }
      });

      // Re-implementing the functions that were in the dialogs before
      function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].classList.remove("active");
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      function toggleCollapsible(event) {
        const header = event.currentTarget;
        const content = header.nextElementSibling;
        header.classList.toggle("active");
        if (content.style.maxHeight && content.style.maxHeight !== "0px") {
          content.style.maxHeight = "0px";
        } else {
          content.style.maxHeight = content.scrollHeight + "px";
          content.addEventListener(
            "transitionend",
            () => {
              if (content.style.maxHeight !== "0px")
                content.style.maxHeight = "none";
            },
            { once: true }
          );
        }
      }
    </script>
  </body>
</html>
